<dom-module id="my-app">
    <link rel="import" type="css" href="my-app.css">

    <template>
        <iron-localstorage name="my-app-user" value="{{user}}" on-iron-localstorage-load-empty="onEmptyUser" on-iron-localstorage-load="inLoadUser"></iron-localstorage>
        <iron-signals on-iron-signal-more-route-change="routeChangedSignal"></iron-signals>
        <!--<fab-element id="appFab" icon="attachment" click-fn="[[fabclick]]"></fab-element>-->
        <dialog-container id="dialogContainer"></dialog-container>
        <my-app-title default>PolyChrome App</my-app-title>

        <paper-drawer-panel id="paperDrawerPanel" class="flex layout vertical" disable-swipe="[[plainPage]]" force-narrow="[[plainPage]]">
            <div drawer class="flex layout vertical" hidden="[[plainPage]]">
                <!-- Drawer Toolbar -->
                <paper-toolbar id="drawerToolbar">
                    <span class="menu-title">Menü</span>
                </paper-toolbar>


                <div id="menuContainer" class="flex">
                    <more-route-selector>
                        <!--Drawer Content--> 
                        <paper-menu class="list">
                            <!--                            <a route="login" href="[[makeUrl('login')]]">
                                                            <iron-icon icon="b"></iron-icon>
                                                            <span>Login</span>
                                                        </a>-->

                            <a route="home" href="[[makeUrl('home')]]">
                                <iron-icon icon="home"></iron-icon>
                                <span>Kezdőlap</span>
                            </a>

                            <a route="users" href="[[makeUrl('users')]]">
                                <iron-icon icon="info"></iron-icon>
                                <span>Felhasználók</span>
                            </a>

                            <a route="contact" href="[[makeUrl('contact')]]">
                                <iron-icon icon="mail"></iron-icon>
                                <span>Kapcsolat</span>
                            </a>

                            <a route="content-2" href="[[makeUrl('content-2')]]">
                                <iron-icon icon="social:domain"></iron-icon>
                                <span><code>content-2</code></span>
                            </a>

                            <a route="fruits" href="[[makeUrl('fruits')]]">
                                <iron-icon icon="my-iconset:grape"></iron-icon>
                                <span>Gyümölcsös</span>
                            </a>

                            <a route="test" href="[[makeUrl('test', testMenuParams)]]">
                                <iron-icon icon="b"></iron-icon>
                                <span>Teszt</span>
                            </a>

                            <a route="test2" href="[[makeUrl('test2', testMenuParams)]]">
                                <iron-icon icon="b"></iron-icon>
                                <span>Teszt 2</span>
                            </a>

                            <a route="xy-z" href="[[makeUrl('xy-z', zParam)]]">
                                <iron-icon icon="b"></iron-icon>
                                <span>Z</span>
                            </a>

                            <!--hidden--> 
                            <a route="login" hidden="true"></a>
                            <!--<a route="test" hidden="true"></a>-->
                            <a route="xy" hidden="true"></a>
                        </paper-menu>
                    </more-route-selector>
                </div>
            </div>
            <div main>
                <toast-service id="toast-service"></toast-service>
                <fab-container id="fab-container"></fab-container>
                <paper-header-panel mode="seamed" class="fullbleed layout vertical">
                    <!-- Main Toolbar -->
                    <paper-toolbar id="mainToolbar" hidden="[[plainPage]]">
                        <paper-icon-button id="paperToggle" icon="menu" paper-drawer-toggle></paper-icon-button>

                        <!-- Application name -->
                        <!--<div class="app-name">PolyChrome App</div>-->
                        <div class="app-name">[[appTitle]]</div>
                        <span class="flex"></span>

                        <!--Toolbar icons--> 
                        <paper-icon-button icon="refresh"></paper-icon-button>
                        <paper-icon-button icon="social:person"></paper-icon-button>

                    </paper-toolbar>

                    <!-- Main Content -->
                    <div class="content flex">
                        <more-route-selector on-more-route-change="routeChanged"> <!-- selected-params="{{params}}" -->
                            <iron-pages attr-for-selected="route" selected="{{route}}">
                                <section route="login">
                                    <login-page page="login" current="[[route]]" user="{{user}}"></login-page>
                                </section>

                                <section route="home">
                                    <!--                                    <fab-element id="homeFab" icon="home" click-fn="[[homeFabClick]]" page="home"></fab-element>
                                                                        <filter-test-page page="home" current="[[route]]"></filter-test-page>-->
                                    <auth-test-page page="home" current="[[route]]"></auth-test-page>
                                </section>

                                <section route="users">
                                    <paper-material elevation="1" class="card">
                                        <h2 class="paper-font-display2">Users</h2>
                                        <p>This is the users section</p>
                                        <a href="[[userInfoUrl('Rob')]]">Rob</a>
                                    </paper-material>
                                </section>

                                <section route="user-info">
                                    <paper-material elevation="1" class="card">
                                        <h2 class="paper-font-display2">
                                            User:<span>{{paramsname}}</span>
                                        </h2>
                                        <div>This is <span>{{paramsname}}</span>'s section</div>
                                        <paper-input value="{{userName}}" label="User name"></paper-input>
                                        <paper-button on-click="goToUserInfo">Ugrás a felhasználóhoz</paper-button>
                                    </paper-material>
                                </section>

                                <section route="contact">
                                    <fab-element id="contactFab" icon="mail" click-fn="[[contactFabClick]]" page="contact"></fab-element>

                                    <paper-material elevation="1" class="card">
                                        <h2 class="paper-font-display2">Contact</h2>
                                        <p>This is the contact section</p>
                                    </paper-material>

                                    <paper-material elevation="1" class="card">
                                        <content-5></content-5>
                                    </paper-material>
                                    <!--                                    <paper-material elevation="1" class="card">
                                                                            <content-4></content-4>
                                                                        </paper-material>-->
                                    <paper-material elevation="1" class="card">
                                        <content-3></content-3>
                                    </paper-material>
                                    <paper-material elevation="1" class="card">
                                        <content-2></content-2>
                                    </paper-material>
                                    <paper-material elevation="1" class="card">
                                        <content-1></content-1>
                                    </paper-material>
                                </section>

                                <section route="content-2">
                                    <simple-page>
                                        <content-2></content-2>
                                    </simple-page>
                                </section>

                                <section route="fruits">
                                    <fruit-page page="fruits" current="[[route]]"></fruit-page>
                                </section>

                                <section route="test">
                                    <paper-material elevation="1" class="card">
                                        <param-test path-params="[[params]]" page="test" current="[[route]]"></param-test>
                                    </paper-material>
                                </section>

                                <section route="test2">
                                    <paper-material elevation="1" class="card">
                                        <param-test path-params="[[params]]" page="test2" current="[[route]]"></param-test>
                                    </paper-material>
                                </section>

                                <section route="xy">
                                    <paper-material elevation="1" class="card">
                                        <p>Ez itt az <code>xy</code> oldal. Nem látszik a menüben.</p>
                                    </paper-material>
                                </section>

                                <section route="xy-z">
                                    <paper-material elevation="1" class="card">
                                        <param-test path-params="[[params]]" page="xy-z" current="[[route]]"></param-test>
                                    </paper-material>
                                </section>
                            </iron-pages>
                        </more-route-selector>
                    </div>
                </paper-header-panel>
            </div>
        </paper-drawer-panel>
    </template>
</dom-module>
<script>
    (function () {
        Polymer({
            is: 'my-app',
            behaviors: [AppBehavior, ToastBehavior, FabBehavior, DialogBehavior],
            properties: {
                route: {
                    type: String,
                    value: 'home'
                },
                appTitle: {
                    type: String
                },
                plainPage: {
                    type: Boolean
                },
                user: {
                    type: Object
                },
                fabclick: {
                    type: Object,
                    value: function () {
                        return function () {
                            ToastBehavior.addToast('my-app elején elhelyezett fab-element.');
                        };
                    }
                },
                homeFabClick: {
                    type: Object,
                    value: function () {
                        return function () {
                            DialogBehavior.showSpinnerDialog('Home fab', 'Türelem...');
                            setTimeout(function () {
                                DialogBehavior.hideSpinnerDialog();
                            }, 3000);
                        };
                    }
                },
                contactFabClick: {
                    type: Object,
                    value: function () {
                        return function () {
                            DialogBehavior.showSpinnerDialog({title: 'Contact fab', text: 'JSON paraméterezés'});
                            setTimeout(function () {
                                DialogBehavior.hideSpinnerDialog();
                            }, 3000);
                        };
                    }
                },
                isFruitsPage: {
                    type: Boolean,
                    computed: "isThisPage(route, 'fruits')"
                },
                isHomePage: {
                    type: Boolean,
                    computed: "isThisPage(route, 'home')"
                },
                testMenuParams: {
                    type: Object,
                    value: {
                        a: 101,
                        b: 203
                    }
                },
                zParam: {
                    type: Object,
                    value: {
                        z: 5
                    }
                },
                paramsname: {
                    type: String,
                    computed: 'getElement(params.name)'
                }
            },
            observers: [ 'userChanged(user.token)' ],
            ready: function () {
                console.log('MyApp is ready.');
                AppBehavior.title.update(this);
                FabBehavior.setCurrentPage(this.route);

                window.onhashchange = function (event) {
                    AppBehavior.route.loadParameters(MoreRouting.getRoute(AppBehavior.route.getRoute()).fullPath);
                };
                var parameters = AppBehavior.route.loadParameters();
                this.set('params', parameters);
            },
            makeUrl: function (pathOrName, params) {
                return MoreRouting.urlFor(pathOrName, params);
            },
            routeChanged: function (p1, p2) {
                var drawerPanel = this.$.paperDrawerPanel;
                if (drawerPanel.narrow) {
                    drawerPanel.closeDrawer();
                }
                FabBehavior.setCurrentPage(this.route);

                if (MoreRouting.isCurrentUrl('login')) {
                    this.set('plainPage', true);
                } else {
                    this.set('plainPage', false);
                }

//                if (MoreRouting.isCurrentUrl('user-info')) {
//                    console.log(MoreRouting.getRoute('user-info').params.name);
//                    this.set('params.name', MoreRouting.getRoute('user-info').params.name);
//                }
//                var p = MoreRouting.getRoute(this.route).params;
//                console.log(this.route + ' ' + JSON.stringify(p));
//                this.params = p1.detail.newParams;
//                console.log(this.params);
            },
            isThisPage: function (route, page) {
                return route === page;
            },
            userInfoUrl: function (name) {
                return this.makeUrl('user-info', {name: name});
            },
            goToUserInfo: function () {
                MoreRouting.navigateTo('user-info', {name: this.userName});
            },
            getElement: function (value) {
                console.log('getElement ' + value + ' ' + JSON.stringify(this.params));
                return value;
            },
            routeChangedSignal: function (data) {
                console.log('routeChangedSignal: ' + JSON.stringify(data));
            },
            onEmptyUser: function(data) {
                console.log('Üres user -> login', data);
                MoreRouting.navigateTo('login');
            },
            onLoadUser: function(data) {
                console.log('Load user', this.get('user'), data);
            },
            userChanged: function(token) {
                console.log(token, this.user, this.get('user'));
                this.set('user', this.user);
            }
        });
    })();
</script>
