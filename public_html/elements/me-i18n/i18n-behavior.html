<script>
    var dir, baseFileName, configured;
    var parametersPattern = /{{(.*?)}}/g;
    var texts, defaultTexts, lang;

    function getTextRecursive(key, texts) {
        var keyParts = key.split('.');

        if (keyParts.length > 1) {
            if (texts[keyParts[0]]) {
                return getTextRecursive(key.substring(keyParts[0].length + 1), texts[keyParts[0]]);
            }
        } else {
            if (texts[keyParts[0]]) {
                return texts[keyParts[0]];
            }
        }
    }

    function loadTexts(lang) {
//        var file = dir + '/' + baseFileName + '-' + lang + '.json';
        var defFile = dir + '/' + baseFileName + '.json';
        var langs, file, res;
        
        
        console.log('lang:', lang);
        
        lang = this.lang ? this.lang : (navigator.language || navigator.userLanguage);
        if (lang.split('-').length > 1) {
            langs = [lang, lang.split('-')[0]];
        } else {
            langs = [lang];
        }
        
        console.log('langs:', langs);

        for (var i in langs) {
            file = dir + '/' + baseFileName + '-' + langs[i] + '.json';
            console.log(file);
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if (request.readyState == 4 && request.status == 200) {
                    res = JSON.parse(request.responseText);
                }
            };
            request.open('GET', file, false);
            request.send();
            }

        if (!res) {
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if (request.readyState == 4 && request.status == 200) {
                    res = JSON.parse(request.responseText);
                }
            };
            request.open('GET', defFile, false);
            request.send();
        }

        return res;
    }

    function getTexts(_lang, nowConfigure) {
        if (!configured && !nowConfigure) {
            console.error('I18N is not configured!');
            return null;
        }

        if (_lang === lang) {
            if (texts) {
                return texts;
            } else {
                return defaultTexts;
            }
        } else {
            var cTexts = loadTexts(_lang);
            if (cTexts) {
                return cTexts;
            } else {
                return defaultTexts;
            }
        }


    }

    I18N = {
        config: function (_dir, _baseFileName, _lang) {
            if (!_dir || !_baseFileName) {
                console.error('dir and base-file-name are required!');
                configured = false;
                return;
            }
            dir = _dir;
            baseFileName = _baseFileName;
            lang = _lang;

            texts = loadTexts(lang);
            defaultTexts = loadTexts();
            configured = true;
        },
        translate: function (key, parameters, _lang) {
            if (!_lang) {
                _lang = lang;
            }
            if (parameters && typeof parameters === 'string') {
                parameters = JSON.parse(parameters);
            }

            if (!configured) {
                console.error('I18N is not configured!');
                return key + '_' + _lang + ' ' + JSON.stringify(parameters);
            }

            var texts = getTexts(_lang);
            var res = getTextRecursive(key, texts);

            if (!res) {
                res = getTextRecursive(key, defaultTexts);
            }
            if (!res) {
                return key + '_' + _lang + ' ' + JSON.stringify(parameters);
            }

            if (parameters) {
                var matches = res.match(parametersPattern);
                for (var i in matches) {
                    var p = matches[i];
                    p = p.substring(2, p.length - 2); // {{...}}
                    if (parameters[p]) {
                        res = res.replace(matches[i], parameters[p]);
                    }
                }
                return res;
            } else {
                return res;
            }
        },
        getLang: function () {
            return lang;
        },
        setLang: function (_lang) {
            console.log('behavior setLang: ' + _lang);
            lang = _lang;
            this.config(dir, baseFileName, _lang);
            var config = document.getElementsByTagName('me-i18n-config')[0];
            config.set('lang', _lang);
        }
    };
</script>
