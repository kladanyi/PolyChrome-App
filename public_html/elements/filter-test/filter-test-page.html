<link rel="import" href="filter-test-filter.html">
<link rel="import" href="filter-test-response.html">

<dom-module id="filter-test-page">
    <style is="custom-style">
        h2.title {
            margin-left: 16px;
            margin-right: 16px;
            margin-bottom: 0;
        }
    </style>
    <template>
        <iron-ajax
            id="listAjax"
            url="[[listAjaxUrl]]"
            method="GET"
            handle-as="json"
            last-response="{{response}}"></iron-ajax>
        <iron-ajax
            id="listAjaxPost"
            url="[[listAjaxUrl]]"
            method="POST"
            handle-as="json"
            last-response="{{responsePost}}"></iron-ajax>

        <fab-element id="refreshFab" icon="refresh" signal-name="refresh-filter-test" page="home"></fab-element>
        <iron-signals on-iron-signal-refresh-filter-test="refresh"></iron-signals>

        <h2 class="title">GET</h2>
        <div class="layout horizontal">
            <paper-material elevation="1" class="card flex">
                <filter-test-filter filter="{{filter}}"></filter-test-filter>
            </paper-material>

            <paper-material elevation="1" class="card flex">
                <filter-test-response response="[[response]]"></filter-test-response>
            </paper-material>
        </div>

        <h2 class="title">POST</h2>
        <div class="layout horizontal">
            <paper-material elevation="1" class="card flex">
                <filter-test-filter filter="{{filterPost}}"></filter-test-filter>
            </paper-material>

            <paper-material elevation="1" class="card flex">
                <filter-test-response response="[[responsePost]]"></filter-test-response>
            </paper-material>
        </div>

    </template>
</dom-module>
<script>
    (function () {
        Polymer({
            is: 'filter-test-page',
            behaviors: [AppBehavior],
            properties: {
                isCurrent: {
                    type: Boolean,
                    observer: 'isCurrentChanged'
                },
                listAjaxUrl: {
                    type: String
                },
                filter: {
                    type: Object,
                    value: {}
                },
                response: {
                    type: Object,
                    observer: 'responseChanged'
                },
                filterPost: {
                    type: Object,
                    value: {}
                },
                responsePost: {
                    type: Object,
                    observer: 'responsePostChanged'
                }
            },
            observers: [
                'filterChanged(filter.name)',
                'filterChanged(filter.number)',
                'filterChanged(filter.dropdown)',
                'filterPostChanged(filterPost.name)',
                'filterPostChanged(filterPost.number)',
                'filterPostChanged(filterPost.dropdown)'
            ],
            isCurrentChanged: function () {
                console.log('filter-test-page isCurrentChanged ' + this.isCurrent);
                if (this.isCurrent) {
                    AppBehavior.setTitle('Összetett szűrés');
                } else {
                    AppBehavior.setTitle();
                }
            },
            refresh: function () {
                this.filterChanged();
                this.filterPostChanged();
            },
            filterChanged: function () {
//                console.log('filterChanged: ' + JSON.stringify(this.filter));
                this.listAjaxUrl = this.listAjaxUrlCompute(this.filter);
                this.$.listAjax.generateRequest();
            },
            filterPostChanged: function () {
                console.log('filterPostChanged: ' + JSON.stringify(this.filterPost));
                this.listAjaxUrlPost = this.listAjaxUrlCompute(this.filterPost);
                this.$.listAjaxPost.generateRequest();
            },
            listAjaxUrlCompute: function (filter) {
                var d = new Date();
                var dString =
                        [d.getFullYear(), ((d.getMonth() < 9 ? '0' : '') + (d.getMonth() + 1)), d.getDate()].join('-')
                        + '_' +
                        [
                            ((d.getHours() < 10 ? '0' : '') + d.getHours()),
                            ((d.getMinutes() < 10 ? '0' : '') + d.getMinutes()),
                            ((d.getSeconds() < 10 ? '0' : '') + d.getSeconds())
                        ].join(':')
                        + '.' +
                        ((d.getMilliseconds() < 10 ? '0' : '') + d.getMilliseconds());

                var paramString = '';
                if (filter.name) {
                    paramString = 'name=' + filter.name;
                }
                if (filter.number) {
                    if (paramString) {
                        paramString += '&';
                    }
                    paramString += 'number=' + filter.number;
                }
                if (filter.dropdown) {
                    if (paramString) {
                        paramString += '&';
                    }
                    paramString += 'dropdown=' + filter.dropdown;
                }

                return'http://localhost:3005/param/' + dString + (paramString ? ('?' + paramString) : '')
            },
            responseChanged: function () {
                this.set('resopnse', this.response);
            },
            responsePostChanged: function () {
                this.set('resopnsePost', this.responsePost);
            }
        });
    })();
</script>
