<link rel="import" href="filter-test-filter.html">
<link rel="import" href="filter-test-response.html">

<dom-module id="filter-test-page">
    <style is="custom-style">
        h2.title {
            margin-left: 16px;
            margin-right: 16px;
            margin-bottom: 0;
        }
    </style>
    <template>
        <iron-ajax
            id="listAjax"
            url="[[listAjaxUrl]]"
            method="GET"
            handle-as="json"
            last-response="{{response}}"></iron-ajax>
        <iron-ajax
            id="listAjaxPost"
            url="[[listAjaxUrl]]"
            body="[[bodyPost]]"
            method="POST"
            handle-as="json"
            last-response="{{responsePost}}"></iron-ajax>

        <iron-ajax
            id="listAjaxPut"
            url="http://localhost:3005/param"
            method="PUT"
            handle-as="text"
            last-response="{{responsePut}}"></iron-ajax>
        <iron-ajax
            id="listAjaxDelete"
            url="http://localhost:3005/param"
            method="DELETE"
            handle-as="text"
            last-response="{{responseDelete}}"></iron-ajax>

        <fab-element id="refreshFab" icon="refresh" signal-name="refresh-filter-test" page="home"></fab-element>
        <iron-signals on-iron-signal-refresh-filter-test="refresh"></iron-signals>

        <h2 class="title">GET</h2>
        <div class="layout horizontal">
            <paper-material elevation="1" class="card flex-1">
                <filter-test-filter filter="{{filter}}"></filter-test-filter>
            </paper-material>

            <paper-material elevation="1" class="card flex-2">
                <filter-test-response response="[[response]]"></filter-test-response>
            </paper-material>
        </div>

        <h2 class="title">POST</h2>
        <div class="layout horizontal">
            <paper-material elevation="1" class="card flex-1">
                <filter-test-filter filter="{{filterPost}}"></filter-test-filter>
            </paper-material>

            <paper-material elevation="1" class="card flex-2">
                <filter-test-response response="[[responsePost]]"></filter-test-response>
            </paper-material>
        </div>

        <div>[[responsePut]]</div>
        <div>[[responseDelete]]</div>

    </template>
</dom-module>
<script>
    (function () {
        Polymer({
            is: 'filter-test-page',
            behaviors: [AppBehavior, MyUtils],
            properties: {
                isCurrent: {
                    type: Boolean,
                    observer: 'isCurrentChanged'
                },
                listAjaxUrl: {
                    type: String
                },
                filter: {
                    type: Object,
                    value: {}
                },
                response: {
                    type: Object,
                    observer: 'responseChanged'
                },
                filterPost: {
                    type: Object,
                    value: {}
                },
                responsePost: {
                    type: Object,
                    observer: 'responsePostChanged'
                },
                bodyPost: {
                    type: Object,
                    value: {}
                },
                responsePut: {
                    type: String,
                    value: 'Ide jön a put...'
                },
                responseDelete: {
                    type: String,
                    value: 'Ide jön a delete...'
                }
            },
            observers: [
                'filterChanged(filter.name)',
                'filterChanged(filter.number)',
                'filterChanged(filter.dropdown)',
                'filterChanged(filter.bools)',
                'filterPostChanged(filterPost.name)',
                'filterPostChanged(filterPost.number)',
                'filterPostChanged(filterPost.dropdown)',
                'filterPostChanged(filterPost.bools)'
            ],
            isCurrentChanged: function () {
                console.log('filter-test-page isCurrentChanged ' + this.isCurrent);
                if (this.isCurrent) {
                    AppBehavior.setTitle('Összetett szűrés');
                } else {
                    AppBehavior.setTitle();
                }
            },
            refresh: function () {
                this.filterChanged();
                this.filterPostChanged();
                this.$.listAjaxPut.generateRequest();
                this.$.listAjaxDelete.generateRequest();
            },
            filterChanged: function () {
                this.listAjaxUrl = this.listAjaxUrlCompute(this.filter);
                this.$.listAjax.generateRequest();
            },
            filterPostChanged: function () {
                this.listAjaxUrlPost = this.listAjaxUrlCompute();
                this.bodyPost = this.listAjaxParamsCompute(this.filterPost);
                console.log(this.bodyPost);
                this.$.listAjaxPost.generateRequest();
            },
            listAjaxUrlCompute: function (filter) {
                var d = new Date();
                var dString =
                        [d.getFullYear(), ((d.getMonth() < 9 ? '0' : '') + (d.getMonth() + 1)), d.getDate()].join('-')
                        + '_' +
                        [
                            ((d.getHours() < 10 ? '0' : '') + d.getHours()),
                            ((d.getMinutes() < 10 ? '0' : '') + d.getMinutes()),
                            ((d.getSeconds() < 10 ? '0' : '') + d.getSeconds())
                        ].join(':')
                        + '.' +
                        ((d.getMilliseconds() < 10 ? '0' : '') + d.getMilliseconds());

                if (filter) {
                    var paramString = this.listAjaxParamsCompute(filter);

                    return'http://localhost:3005/param/' + dString + (paramString ? ('?' + paramString) : '');
                } else {
                    return'http://localhost:3005/param/' + dString;
                }
            },
            listAjaxParamsCompute: function (filter) {
                var paramString = 'teszt=1&teszt=2&teszt=3';
                if (filter.name) {
                    if (paramString) {
                        paramString += '&';
                    }
                    paramString += 'name=' + filter.name;
                }
                if (filter.number) {
                    if (paramString) {
                        paramString += '&';
                    }
                    paramString += 'number=' + filter.number;
                }
                if (filter.dropdown) {
                    if (paramString) {
                        paramString += '&';
                    }
                    paramString += 'dropdown=' + filter.dropdown;
                }

                if (paramString) {
                    paramString += '&';
                }
                var boolParam = '';
                for (var i in filter.bools) {
                    var keys = MyUtils.JSON.getKeys(filter.bools[i]);
                    for (var j in keys) {
                        if (boolParam) {
                            boolParam += '&';
                        }
                        boolParam += 'bools.' + keys[j] + '=' + MyUtils.JSON.getElement(filter, 'bools.' + i + '.' + keys[j]);
                    }
                }
                console.log('boolParam: ' + boolParam);
                paramString += boolParam;

                return paramString;
            },
            responseChanged: function () {
                this.set('resopnse', this.response);
            },
            responsePostChanged: function () {
                this.set('resopnsePost', this.responsePost);
            }
        });
    })();
</script>
